@echo off
setlocal

set SVN_DEV=${buildout:directory}/${svn-dev:destination}
set SVN_BDB=${buildout:directory}/${svn-db4:destination}
set SVN_LIBINTL=${buildout:directory}/${svn-libintl:destination}
set TBZR=${buildout:directory}/tbzr/trunk
set ROOT=${buildout:directory}
set RELEASE=%ROOT%\release\bzr.${settings:bzr-latest}
set INSTALLERS=%ROOT%\installers
set PYTHON=${buildout:executable}
set BUILD_ERROR=0
set ORIGINAL_PYTHONPATH=%PYTHONPATH%
set ORIGINAL_DIRECTORY=%CD%

set TORTOISE_OVERLAYS_MSI_WIN32_CMD=%PYTHON% %ROOT%/ostools.py basename ${settings:tortoise-overlays-win32-url}
FOR /f "tokens=1 delims= " %%G IN ('%TORTOISE_OVERLAYS_MSI_WIN32_CMD%') DO set BASENAME=%%G
set TORTOISE_OVERLAYS_MSI_WIN32=${buildout:directory}/tortoise-overlays/%BASENAME%

set TORTOISE_OVERLAYS_MSI_X64_CMD=%PYTHON% %ROOT%/ostools.py basename ${settings:tortoise-overlays-x64-url}
FOR /f "tokens=1 delims= " %%G IN ('%TORTOISE_OVERLAYS_MSI_X64_CMD%') DO set BASENAME=%%G
set TORTOISE_OVERLAYS_MSI_X64=${buildout:directory}/tortoise-overlays/%BASENAME%

FOR /f "tokens=1 delims= " %%G IN ('cygpath %PYTHON%') DO set CYG_PYTHON=%%G

%PYTHON% %ROOT%/ostools.py remove %RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

md %RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

%PYTHON% %ROOT%/ostools.py remove %INSTALLERS%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

md %INSTALLERS%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

bzr co %ROOT%/bzr/latest %RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %ROOT%/subvertpy/latest
%PYTHON% setup.py install -O1 --install-lib=%RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %ROOT%/bzrtools/latest
%PYTHON% setup.py install -O1 --install-lib=%RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %ROOT%/qbzr/latest
%PYTHON% setup.py install -O1 --install-lib=%RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %ROOT%/bzr-svn/latest
%PYTHON% setup.py install -O1 --install-lib=%RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %ROOT%/bzr-rebase/latest
%PYTHON% setup.py install -O1 --install-lib=%RELEASE%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

set PYTHONPATH=%PYTHONPATH%;%RELEASE%
cd %ROOT%/tbzr/trunk
%PYTHON% setup.py build
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

cd %RELEASE%
make installer PYTHON=%CYG_PYTHON%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

rem Enable this when this branch is merged.
rem make python-installer PYTHON24=${settings:python24} PYTHON25=${settings:python25}
rem @if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

${settings:python24} setup.py bdist_wininst --install-script="bzr-win32-bdist-postinstall.py" -d .
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

${settings:python25} setup.py bdist_wininst --install-script="bzr-win32-bdist-postinstall.py" -d .
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

%PYTHON% %ROOT%/ostools.py copytodir %RELEASE%/bzr*.exe %INSTALLERS%
@if %ERRORLEVEL% NEQ 0 (set BUILD_ERROR=%ERRORLEVEL%) & goto End

:End
set PYTHONPATH=%ORIGINAL_PYTHONPATH%
cd %ORIGINAL_DIRECTORY%
exit /b %BUILD_ERROR%
